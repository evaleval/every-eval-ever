name: One-time JSON to JSONL Rename

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  rename-files:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Find and rename JSON files to JSONL
      run: |
        echo "ðŸ” Finding JSON files to rename..."
        
        # Find all .json files and count them
        json_count=$(find . -name "*.json" -not -path "./.git/*" | wc -l)
        echo "ðŸ“Š Found $json_count JSON files to rename"
        
        if [ $json_count -eq 0 ]; then
          echo "âœ… No JSON files found to rename"
          exit 0
        fi
        
        # Create a list of files to rename
        find . -name "*.json" -not -path "./.git/*" > files_to_rename.txt
        
        echo "ðŸ“ Files to rename:"
        head -10 files_to_rename.txt
        if [ $json_count -gt 10 ]; then
          echo "... and $(($json_count - 10)) more files"
        fi
        
        # Rename files in batches to avoid overwhelming git
        batch_size=100
        batch_num=1
        
        while IFS= read -r json_file; do
          if [ -f "$json_file" ]; then
            # Get the directory and filename without extension
            dir=$(dirname "$json_file")
            filename=$(basename "$json_file" .json)
            jsonl_file="$dir/$filename.jsonl"
            
            # Rename the file
            git mv "$json_file" "$jsonl_file"
            echo "âœ… Renamed: $json_file -> $jsonl_file"
          fi
          
          # Commit in batches to avoid huge commits
          if [ $((batch_num % batch_size)) -eq 0 ]; then
            echo "ðŸ’¾ Committing batch $((batch_num / batch_size))..."
            git add -A
            git commit -m "Batch rename JSON to JSONL (files $((batch_num - batch_size + 1))-$batch_num)"
          fi
          
          batch_num=$((batch_num + 1))
        done < files_to_rename.txt
        
        # Commit any remaining files
        if [ $(git diff --cached --name-only | wc -l) -gt 0 ]; then
          echo "ðŸ’¾ Committing final batch..."
          git add -A
          git commit -m "Final batch rename JSON to JSONL (remaining files)"
        fi
        
        echo "ðŸŽ‰ All JSON files renamed to JSONL!"
        
        # Cleanup
        rm -f files_to_rename.txt
    
    - name: Verify rename operation
      run: |
        echo "ðŸ” Verification after rename:"
        echo "ðŸ“Š Remaining JSON files: $(find . -name "*.json" -not -path "./.git/*" | wc -l)"
        echo "ðŸ“Š New JSONL files: $(find . -name "*.jsonl" -not -path "./.git/*" | wc -l)"
        
        echo "ðŸ“ Sample of new JSONL files:"
        find . -name "*.jsonl" -not -path "./.git/*" | head -5
    
    - name: Push changes
      run: |
        echo "ðŸš€ Pushing changes to repository..."
        git push origin main
        echo "âœ… Successfully pushed all renamed files!"
    
    - name: Summary
      run: |
        echo "ðŸŽ‰ JSON to JSONL rename operation completed!"
        echo "âœ… All .json files have been renamed to .jsonl"
        echo "âœ… HuggingFace datasets will now properly detect JSONL format"
        echo "âœ… Statistics generation should work correctly"
        echo ""
        echo "ðŸ“‹ Next steps:"
        echo "1. Clear HuggingFace datasets cache if needed"
        echo "2. Run statistics generation to verify it works"
        echo "3. This workflow can be deleted after successful verification"
