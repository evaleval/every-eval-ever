name: Weekly Evaluation Data Processing

on:
  schedule:
    # Weekly: Monday 03:00 UTC
    - cron: '0 3 * * 1'
  workflow_dispatch: {}

jobs:
  validate_env:
    name: Validate environment (quick test)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install minimal system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3 libatk1.0-0 libatk-bridge2.0-0 libx11-xcb1 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libxshmfence1 libgtk-3-0 || true

      - name: Install Python dependencies (quick)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install playwright huggingface_hub

      - name: Quick import check
        run: |
          python -c "
          try:
              import sys
              import pandas
              import pyarrow
              import playwright
              import huggingface_hub
              print('✅ All imports successful')
          except Exception as e:
              print(f'❌ Import check failed: {e}')
              raise
          "

  scrape_and_upload:
    name: Process Evaluation Data and Upload to HuggingFace
    needs: validate_env
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system packages required by Playwright
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3 libatk1.0-0 libatk-bridge2.0-0 libx11-xcb1 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libxshmfence1 libgtk-3-0

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install playwright huggingface_hub
          # Install browsers for Playwright (non-interactive, includes deps)
          python -m playwright install --with-deps

      - name: Process evaluation data and upload to HuggingFace
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          PYTHONUNBUFFERED: 1
        run: |
          # Currently processing HELM data
          # Future: Add parallel processing of multiple sources
          #   - HELM (current)
          #   - OpenAI Evals  
          #   - BigBench
          #   - etc.
          python scripts/incremental_upload.py \
            --repo-id evaleval/every_eval_ever \
            --benchmarks lite mmlu classic \
            --source-name helm \
            --max-workers 2 \
            --timeout 3600
